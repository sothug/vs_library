-------------------------------------------------------------------------
--------------------- Copyright (c) samisalreadytaken -------------------
--- v0.1.2 --------------------------------------------------------------
local VER="v0.1.2"if not _VS then _VS={}elseif _VS[VER]then return _VS[VER]end local VS={}_VS[VER]=VS VS.MAX_COORD_FLOAT=16384.0 VS.MAX_TRACE_LENGTH=56755.84086241697115430736 VS.DEG2RAD=0.01745329251994329576 VS.RAD2DEG=57.29577951308232087679 VS.PI=3.14159265358979323846 VS.RAND_MAX=0x7FFF local Msg,Warning=Msg,Warning local append,select,type,f,floor=table.insert,select,type,string.format,math.floor local unpack,pack=unpack,function(...)return{n=select("#",...),...}end if not table.pack then table.pack=pack end if not table.unpack then table.unpack=unpack end local throw=function(msg)local info=debug.getinfo(2,"Sl")Warning(msg)Warning(f("\t%s:%d\n",info.short_src,info.currentline))return false end if IsServer()then do local tQueue={}local nCompletedInQueue=0 local bPlayerSpawned=false function VS.OnPlayerSpawn(...)local ply=Entities:GetLocalPlayer()if bPlayerSpawned or ply and type(ply)=="table"and type(ply.__self)=="userdata"and not ply:IsNull()and ply:GetClassname()=="player"then return Warning("VS::OnPlayerSpawn: player is already spawned\n")end local argv=pack(...)local func=argv[1]if argv.n==0 or type(func)~="function"then return throw("VS::OnPlayerSpawn: invalid parameter 1\n")end local info=debug.getinfo(func,"S")for i=1,#tQueue do if tQueue[tQueue[i]].source==info.source then return throw("VS::OnPlayerSpawn: found event from this file in the queue, aborting\n")end end local msg="VS::OnPlayerSpawn: closure added to queue"local err_cb,err_msg,params if argv.n>1 then local typ=type(argv[2])if typ=="string"then err_msg=argv[2]elseif typ=="function"then err_cb=argv[2]elseif typ~="nil"then return throw("VS::OnPlayerSpawn: parameter 2 has an invalid type '"..typ.."' ; expected 'string|function'\n")end if argv.n>2 then params={}for i=3,argv.n do append(params,argv[i])end msg=msg.." with "..tostring(#params).." parameter(s)"end end append(tQueue,func)tQueue[func]={bSuccess=false,params=params,err_cb=err_cb,err_msg=err_msg,source=info.source,src=info.short_src,line=info.linedefined}Msg(msg.."\n")return true end local function RunQueue()local len=#tQueue for i=1,len do local f=tQueue[i]local t=tQueue[f]if not t.bSuccess then local p,r=t.params if p then r=f(unpack(p))else r=f()end if r or r==nil then t.bSuccess=true nCompletedInQueue=nCompletedInQueue+1 end end end if nCompletedInQueue==len then return true else return false end end local function FixLevelChange()local bIsTools=IsInToolsMode()local szMapName=GetMapName()if szMapName=="a1_intro_world"then local hCmd=Entities:FindByName(nil,"command_change_level")if hCmd then hCmd:Kill()end local e=Entities:FindByName(nil,"relay_stun_player")if e then e:GetOrCreatePrivateScriptScope().OnTriggerLevelChange=function()e:SetContextThink("VS_LevelChange",function()if bIsTools then SendToConsole("addon_tools_map a1_intro_world_2")else SendToConsole("addon_play a1_intro_world_2")end end,1.5)end e:RedirectOutput("OnTrigger","OnTriggerLevelChange",e)end end end local function Destroy()throw=nil tQueue=nil RunQueue=nil nCompletedInQueue=nil FixLevelChange=nil Destroy=nil end if not _VS.__iEventSpawn and not Entities:GetLocalPlayer()then _VS.__iEventSpawn=ListenToGameEvent("player_connect_full",function()bPlayerSpawned=true if _VS.__hSpawnInit then _VS.__hSpawnInit:Kill()_VS.__hSpawnInit=nil end FixLevelChange()if not RunQueue()then local nInitCount=0 _VS.__hSpawnInit=Entities:CreateByClassname("soundent")_VS.__hSpawnInit:SetContextThink("",function()nInitCount=nInitCount+1 if RunQueue()or nInitCount>10 then if nInitCount>10 then Warning(f("VS::PostPlayerSpawn: timeout, failed to execute %d function(s)\n",#tQueue-nCompletedInQueue))for i=1,#tQueue do local t=tQueue[tQueue[i]]if not t.bSuccess then if t.err_msg then Warning(t.err_msg.."\n")elseif t.err_cb then t.err_cb()else Warning(f("\t%s:%d\n",t.src,t.line))end end end end Destroy()nInitCount=nil _VS.__hSpawnInit:Kill()_VS.__hSpawnInit=nil StopListeningToGameEvent(_VS.__iEventSpawn)_VS.__iEventSpawn=nil return end return 1.0 end,1.0)Msg("VS::PostPlayerSpawn: running ("..tostring(_VS.__hSpawnInit:entindex())..")\n")else Destroy()StopListeningToGameEvent(_VS.__iEventSpawn)_VS.__iEventSpawn=nil end end,nil)end end end function VS.IsAddonEnabled(s)for a in Convars:GetStr("default_enabled_addons_list"):gmatch("[^,]+")do if a==s then return true end end return false end function VS.IsInteger(f)return floor(f)==f end function VS.IsLookingAt(s,t,v,f)return(t-s):Normalized():Dot(v)>=f end function VS.PointOnLineNearestPoint(a,b,c)local v1=b-a local v1l=v1:Length()local d=v1:Dot(c-a)/(v1l*v1l)if d<0.0 then return a elseif d>1.0 then return b else return a+v1*d end end function VS.Approach(t,v,s)local d=t-v if d>s then v=v+s elseif d<-s then v=v-s else v=t end return v end function VS.ApproachAngle(t,v,s)t=t%360.0 if t>180.0 then t=t-360.0 elseif t<-180.0 then t=t+360.0 end v=v%360.0 if v>180.0 then v=v-360.0 elseif v<-180.0 then v=v+360.0 end local d=t-v d=d%360.0 if d>180.0 then d=d-360.0 elseif d<-180.0 then d=d+360.0 end if s<0 then s=-s end if d>s then v=v+s elseif d<-s then v=v-s else v=t end return v end function VS.AngleDiff(dst,src)local a=dst-src a=a%360.0 if a>180.0 then a=a-360.0 elseif a<-180.0 then a=a+360.0 end return a end function VS.AngleNormalize(a)a=a%360.0 if a>180.0 then a=a-360.0 elseif a<-180.0 then a=a+360.0 end return a end function VS.QAngleNormalize(a)a.x=a.x%360.0 a.y=a.y%360.0 a.z=a.z%360.0 if a.x>180.0 then a.x=a.x-360.0 elseif a.x<-180.0 then a.x=a.x+360.0 end if a.y>180.0 then a.y=a.y-360.0 elseif a.y<-180.0 then a.y=a.y+360.0 end if a.z>180.0 then a.z=a.z-360.0 elseif a.z<-180.0 then a.z=a.z+360.0 end end function VS.SnapDirectionToAxis(v,e)local p=1.0-e local x if v.x<0 then x=-v.x else x=v.x end if x>p then if v.x<0.0 then v.x=-1.0 else v.x=1.0 end v.y=0.0 v.z=0.0 return v end local y if v.y<0 then y=-v.y else y=v.y end if y>p then if v.y<0.0 then v.y=-1.0 else v.y=1.0 end v.z=0.0 v.x=0.0 return v end local z if v.z<0 then z=-v.z else z=v.z end if z>p then if v.z<0.0 then v.z=-1.0 else v.z=1.0 end v.x=0.0 v.y=0.0 return v end end function VS.VectorsAreEqual(a,b,t)if not t then t=0 end local x=a.x-b.x if x<0 then x=-x end local y=a.y-b.y if y<0 then y=-y end local z=a.z-b.z if z<0 then z=-z end return(x<=t and y<=t and z<=t)end function VS.IsPointInBox(v,i,x)return(v.x>=i.x and v.x<=x.x and v.y>=i.y and v.y<=x.y and v.z>=i.z and v.z<=x.z)end function VS.IsBoxIntersectingBox(min1,max1,min2,max2)if(min1.x>max2.x)or(max1.x<min2.x)then return false elseif(min1.y>max2.y)or(max1.y<min2.y)then return false elseif(min1.z>max2.z)or(max1.z<min2.z)then return false else return true end end if package.loaded["utils.utilsinit"]then function Deg2Rad(deg)return deg*0.01745329251994329576 end function Rad2Deg(rad)return rad*57.29577951308232087679 end function VectorDistanceSq(v1,v2)local l=(v1-v2):Length()return l*l end function VectorDistance(v1,v2)return(v1-v2):Length()end function VectorLerp(t,a,b)local c=(b-a)*t return a+c end end return VS
